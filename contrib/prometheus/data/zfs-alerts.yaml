---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
    name: zfs-alerts
    namespace: monitoring
    labels:
        prometheus: system-rules-prometheus
spec:
    groups:
        - name: zfs_exporter
          rules:
            - alert: ZfsExporterDown
              for: 5m
              expr: up{job="zfs_exporter"} == 0
              labels:
                severity: critical
              annotations:
                summary: ZFS exporter is down on {{ $labels.instance }}
            - alert: ZfsCommandFailure
              for: 2m
              expr: zfs_up == 0
              labels:
                severity: critical
              annotations:
                summary: ZFS commands failing on {{ $labels.instance }}
            - alert: ZfsPoolDegraded
              for: 1m
              expr: zfs_pool_health{state="degraded"} == 1
              labels:
                severity: critical
              annotations:
                description: A vdev in pool {{ $labels.pool }} has failed. Check zpool status for details.
                summary: ZFS pool {{ $labels.pool }} is DEGRADED (drive failure)
            - alert: ZfsPoolFaulted
              for: 0m
              expr: zfs_pool_health{state="faulted"} == 1
              labels:
                severity: critical
              annotations:
                description: Pool {{ $labels.pool }} has experienced too many failures and is no longer accessible.
                summary: ZFS pool {{ $labels.pool }} is FAULTED
            - alert: ZfsPoolDegradedNotResilvering
              for: 10m
              expr: |-
                (zfs_pool_health{state="degraded"} == 1)
                  unless on(pool)
                (zfs_pool_resilver_active == 1)
              labels:
                severity: critical
              annotations:
                description: A drive has failed in pool {{ $labels.pool }} and no resilver is in progress. Manual intervention required.
                summary: Pool {{ $labels.pool }} is degraded but NOT resilvering
            - alert: ZfsPoolResilvering
              for: 0m
              expr: zfs_pool_resilver_active == 1
              labels:
                severity: warning
              annotations:
                description: A drive rebuild is underway for pool {{ $labels.pool }}.
                summary: Pool {{ $labels.pool }} resilver in progress ({{ $value | humanizePercentage }} complete)
            - alert: ZfsPoolResilverStalled
              for: 30m
              expr: |-
                (zfs_pool_resilver_active == 1)
                  and
                (delta(zfs_pool_scan_progress_ratio[30m]) == 0)
              labels:
                severity: critical
              annotations:
                description: Resilver progress has not advanced in 30 minutes.
                summary: Resilver stalled on pool {{ $labels.pool }}
            - alert: ZfsPoolNotOnline
              for: 1m
              expr: |-
                (zfs_pool_health{state="online"} == 0)
                  unless on(pool)
                (zfs_pool_health{state="degraded"} == 1)
                  unless on(pool)
                (zfs_pool_health{state="faulted"} == 1)
              labels:
                severity: critical
              annotations:
                summary: ZFS pool {{ $labels.pool }} is not ONLINE
            - alert: ZfsPoolReadOnly
              for: 1m
              expr: zfs_pool_readonly == 1
              labels:
                severity: warning
              annotations:
                summary: ZFS pool {{ $labels.pool }} is read-only
            - alert: ZfsPoolCapacityWarning
              for: 15m
              expr: (zfs_pool_allocated_bytes / zfs_pool_size_bytes) > 0.80
              labels:
                severity: warning
              annotations:
                summary: ZFS pool {{ $labels.pool }} is {{ $value | humanizePercentage }} full
            - alert: ZfsPoolCapacityCritical
              for: 5m
              expr: (zfs_pool_allocated_bytes / zfs_pool_size_bytes) > 0.90
              labels:
                severity: critical
              annotations:
                summary: ZFS pool {{ $labels.pool }} is {{ $value | humanizePercentage }} full
            - alert: ZfsPoolFragmentationHigh
              for: 1h
              expr: zfs_pool_fragmentation_ratio > 0.50
              labels:
                severity: warning
              annotations:
                summary: ZFS pool {{ $labels.pool }} fragmentation is {{ $value | humanizePercentage }}
            - alert: ZfsServiceDown
              for: 2m
              expr: zfs_service_up == 0
              labels:
                severity: critical
              annotations:
                summary: Service {{ $labels.service }} is down on {{ $labels.instance }}
            - alert: ZfsNFSSharesWithoutService
              for: 2m
              expr: |-
                (count(zfs_dataset_share_nfs == 1) > 0)
                  and
                (zfs_service_up{service="nfs"} == 0)
              labels:
                severity: critical
              annotations:
                summary: NFS shares configured but NFS service is down on {{ $labels.instance }}
            - alert: ZfsSMBSharesWithoutService
              for: 2m
              expr: |-
                (count(zfs_dataset_share_smb == 1) > 0)
                  and
                (zfs_service_up{service="smb"} == 0)
              labels:
                severity: critical
              annotations:
                summary: SMB shares configured but SMB service is down on {{ $labels.instance }}
            - alert: ZfsDatasetAbnormalGrowth
              for: 1h
              expr: |-
                (
                  (zfs_dataset_used_bytes - zfs:dataset_used_bytes:avg7d)
                    > 2 * zfs:dataset_used_bytes:stddev7d
                )
                and
                (
                  (zfs_dataset_used_bytes - zfs:dataset_used_bytes:avg7d)
                    > max(1073741824, 0.1 * zfs:dataset_used_bytes:avg7d)
                )
              labels:
                severity: warning
              annotations:
                description: Current usage has deviated more than 2 standard deviations from the 7-day average and exceeds the minimum threshold floor.
                summary: Dataset {{ $labels.dataset }} usage is outside normal 7-day range
            - alert: ZfsDatasetAbnormalGrowthShortTerm
              for: 30m
              expr: |-
                (
                  (zfs_dataset_used_bytes - zfs:dataset_used_bytes:avg1d)
                    > 3 * zfs:dataset_used_bytes:stddev1d
                )
                and
                (
                  (zfs_dataset_used_bytes - zfs:dataset_used_bytes:avg1d)
                    > max(1073741824, 0.1 * zfs:dataset_used_bytes:avg1d)
                )
              labels:
                severity: warning
              annotations:
                description: Current usage has deviated more than 3 standard deviations from the 1-day average and exceeds the minimum threshold floor.
                summary: Dataset {{ $labels.dataset }} usage spiking beyond 1-day baseline
            - alert: ZfsPoolPredictedFull7d
              for: 1h
              expr: predict_linear(zfs_pool_free_bytes[7d], 7 * 24 * 3600) < 0
              labels:
                severity: warning
              annotations:
                description: Based on 7-day growth trend, pool {{ $labels.pool }} will run out of space.
                summary: Pool {{ $labels.pool }} predicted to fill within 7 days
            - alert: ZfsPoolPredictedFull1d
              for: 30m
              expr: predict_linear(zfs_pool_free_bytes[1d], 24 * 3600) < 0
              labels:
                severity: critical
              annotations:
                description: Based on 1-day growth trend, pool {{ $labels.pool }} will run out of space imminently.
                summary: Pool {{ $labels.pool }} predicted to fill within 24 hours
